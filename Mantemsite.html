<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>An√°lise de Desempenho do Mant√©m</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1A202C; /* Fundo escuro */
            color: #E2E8F0; /* Cor de texto padr√£o clara */
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            height: 300px;
            max-height: 350px;
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 350px;
                max-height: 400px;
            }
        }
        .material-card {
            background-color: #2D3748; /* Cart√µes escuros */
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.2); /* Sombra mais escura */
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        h1, h2, h3 {
            color: #E2E8F0; /* T√≠tulos claros */
        }
        p, li, th, td, span {
            color: #CBD5E0; /* Texto claro */
        }
        .accent-text {
            color: #FF6B6B; /* Coral Vivo - destaque */
        }
        .stat-number {
            font-size: 3rem;
            font-weight: 700;
            color: #06D6A0; /* Azul Cer√∫leo Din√¢mico - destaque */
        }
        .section-intro-text {
            font-size: 1.125rem;
            line-height: 1.75rem;
            margin-bottom: 1rem;
        }
        .chart-title {
            text-align: center;
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: #E2E8F0; /* T√≠tulo do gr√°fico claro */
        }
        .swot-item {
            padding: 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }
        .swot-strength { background-color: #38A169; color: #E8F5E9; } /* Verde mais escuro */
        .swot-weakness { background-color: #E53E3E; color: #FFEBEE; } /* Vermelho mais escuro */
        .swot-opportunity { background-color: #3182CE; color: #E0F7FA; } /* Azul mais escuro */
        .swot-threat { background-color: #DD6B20; color: #FFFDE7; } /* Laranja mais escuro */
        .player-input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #4A5568; /* Borda mais escura */
            border-radius: 0.25rem;
            box-sizing: border-box;
            background-color: #4A5568; /* Fundo do input escuro */
            color: #E2E8F0; /* Texto do input claro */
        }
        /* Estilos do Modal */
        .modal {
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6); /* Fundo do modal mais escuro */
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #2D3748; /* Fundo do modal escuro */
            margin: auto;
            padding: 20px;
            border: 1px solid #4A5568; /* Borda do modal escura */
            width: 90%;
            max-width: 800px;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.2);
            position: relative;
        }
        .close-button {
            color: #CBD5E0; /* Bot√£o fechar claro */
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close-button:hover,
        .close-button:focus {
            color: #E2E8F0; /* Bot√£o fechar hover claro */
            text-decoration: none;
            cursor: pointer;
        }
        .match-input, .match-select {
            width: 100%;
            padding: 0.25rem;
            border: 1px solid #4A5568; /* Borda do input/select de partida escura */
            border-radius: 0.25rem;
            box-sizing: border-box;
            font-size: 0.875rem;
            background-color: #4A5568; /* Fundo do input/select de partida escuro */
            color: #E2E8F0; /* Texto do input/select de partida claro */
        }
        /* Estilos da Tier List */
        .tier-list-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 2rem;
        }
        .tier-card {
            padding: 1rem;
            border-radius: 0.5rem;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .tier-card h4 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        .tier-s { background-color: #FF6B6B; color: #073B4C; } /* Coral Vivo */
        .tier-a { background-color: #FFD166; color: #073B4C; } /* Amarelo Vibrante */
        .tier-b { background-color: #06D6A0; color: #073B4C; } /* Verde Esmeralda */
        .tier-c { background-color: #118AB2; color: #E2E8F0; } /* Azul Cer√∫leo Din√¢mico */
        .tier-d { background-color: #577590; color: #E2E8F0; } /* Cinza Azulado */
        .tier-player-name {
            font-weight: 600;
            margin-bottom: 0.25rem;
            color: inherit; /* Herda a cor do texto do tier */
        }
    </style>
</head>
<body class="antialiased">
    <header class="bg-[#073B4C] text-white py-8 shadow-lg">
        <div class="container mx-auto px-6 text-center">
            <h1 class="text-4xl font-bold text-white">An√°lise de Desempenho do Mant√©m</h1>
            <p class="text-xl mt-2 text-[#FFD166]">Acompanhe Suas Estat√≠sticas e Evolu√ß√£o no LoL</p>
        </div>
    </header>

    <main class="container mx-auto px-6 py-8">

        <section id="ranking-jogadores" class="material-card text-center">
            <h2 class="text-3xl font-semibold mb-4">Ranking de Desempenho dos Jogadores</h2>
            <p class="section-intro-text">
                Este ranking apresenta os jogadores classificados em tiers (S, A, B, C, D) com base na sua pontua√ß√£o de desempenho m√©dio, que considera a combina√ß√£o de abates, assist√™ncias, mortes, CS/min e placar de vis√£o, com pesos ajustados para a lane principal de cada jogador. A Tier S √© reservada para os 3 melhores desempenhos.
            </p>
            <div id="tierListDisplay" class="tier-list-container">
                </div>
        </section>

        <section id="metricas-chave" class="material-card">
            <h2 class="text-3xl font-semibold mb-6 text-center">M√©tricas Essenciais de Desempenho</h2>
            <p class="section-intro-text text-center">
                Para entender o desempenho, √© crucial analisar as m√©tricas que refletem diferentes aspectos do jogo. Abates (Kills), Mortes (Deaths), CS/min (Creep Score por minuto) e Placar de Vis√£o (Vision Score) s√£o indicadores prim√°rios.
            </p>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-center">
                <div>
                    <h3 class="chart-title">Desempenho M√©dio por Jogador (√öltimas Partidas)</h3>
                    <div class="chart-container h-[350px] md:h-[400px]">
                        <canvas id="playerOverviewChart"></canvas>
                    </div>
                    <p class="text-center mt-4 text-sm text-gray-700">Comparativo das estat√≠sticas m√©dias dos jogadores.</p>
                </div>
                <div>
                    <h3 class="chart-title">Import√¢ncia das M√©tricas</h3>
                    <div class="space-y-4 mt-6 md:mt-12">
                        <div class="bg-[#2D3748] p-4 rounded-lg shadow">
                            <h4 class="font-semibold text-lg text-[#118AB2]">‚öîÔ∏è Abates (Kills)</h4>
                            <p class="text-sm text-[#CBD5E0]">Reflete a capacidade ofensiva e de garantir vantagens no mapa.</p>
                        </div>
                        <div class="bg-[#2D3748] p-4 rounded-lg shadow">
                            <h4 class="font-semibold text-lg text-[#FF6B6B]">üíÄ Mortes (Deaths)</h4>
                            <p class="text-sm text-[#CBD5E0]">Indica a capacidade de sobreviv√™ncia e posicionamento seguro.</p>
                        </div>
                         <div class="bg-[#2D3748] p-4 rounded-lg shadow">
                            <h4 class="font-semibold text-lg text-[#FFD166]">üí∞ CS/min (Creep Score por Minuto)</h4>
                            <p class="text-sm text-[#CBD5E0]">Mede a efici√™ncia na coleta de ouro e experi√™ncia atrav√©s de minions.</p>
                        </div>
                        <div class="bg-[#2D3748] p-4 rounded-lg shadow">
                            <h4 class="font-semibold text-lg text-[#06D6A0]">üëÅÔ∏è Placar de Vis√£o (Vision Score)</h4>
                            <p class="text-sm text-[#CBD5E0]">Quantifica a contribui√ß√£o para o controle de vis√£o do mapa.</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="tabela-detalhada" class="material-card">
            <h2 class="text-3xl font-semibold mb-6 text-center">Estat√≠sticas Detalhadas dos Jogadores (Edite Aqui)</h2>
            <p class="section-intro-text text-center">
                Altere o nome do jogador diretamente na tabela. Para gerenciar as estat√≠sticas de partidas individuais, clique no bot√£o "Gerenciar Partidas".
            </p>
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white rounded-lg shadow-md">
                    <thead>
                        <tr class="bg-[#118AB2] text-white">
                            <th class="py-3 px-4 text-left rounded-tl-lg">Jogador</th>
                            <th class="py-3 px-4 text-left">Abates (K) M√©dia</th>
                            <th class="py-3 px-4 text-left">Mortes (D) M√©dia</th>
                            <th class="py-3 px-4 text-left">Assist√™ncias (A) M√©dia</th>
                            <th class="py-3 px-4 text-left">CS/min M√©dia</th>
                            <th class="py-3 px-4 text-left rounded-tr-lg">Placar de Vis√£o M√©dia</th>
                            <th class="py-3 px-4 text-left">A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="playerStatsTableBody">
                    </tbody>
                </table>
            </div>
            <div class="text-center mt-6">
                <button id="addPlayerBtn" class="bg-[#06D6A0] hover:bg-[#05B88D] text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300">
                    Adicionar Novo Jogador
                </button>
            </div>
        </section>

    </main>

    <footer class="bg-[#073B4C] text-white py-6 mt-12">
        <div class="container mx-auto px-6 text-center">
            <p class="text-sm">&copy; <span id="currentYear"></span> An√°lise de Desempenho do Mant√©m. Dados ilustrativos.</p>
            <p class="text-xs mt-1">Este infogr√°fico foi gerado utilizando Chart.js para visualiza√ß√µes em Canvas e Tailwind CSS para estiliza√ß√£o. Os dados s√£o armazenados no Firestore.</p>
        </div>
    </footer>

    <div id="matchManagementModal" class="modal hidden">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h3 class="text-2xl font-semibold mb-4 text-center text-[#E2E8F0]">Gerenciar Partidas de <span id="modalPlayerName" class="accent-text"></span></h3>
            
            <div class="overflow-x-auto mb-4">
                <table class="min-w-full bg-[#2D3748] rounded-lg shadow-md">
                    <thead>
                        <tr class="bg-[#FFD166] text-[#073B4C]">
                            <th class="py-2 px-3 text-left">Partida #</th>
                            <th class="py-2 px-3 text-left">Lane</th>
                            <th class="py-2 px-3 text-left">Abates (K)</th>
                            <th class="py-2 px-3 text-left">Mortes (D)</th>
                            <th class="py-2 px-3 text-left">Assist√™ncias (A)</th>
                            <th class="py-2 px-3 text-left">CS/min</th>
                            <th class="py-2 px-3 text-left">Placar de Vis√£o</th>
                            <th class="py-2 px-3 text-left">A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="modalMatchesTableBody">
                    </tbody>
                </table>
            </div>
            <div class="text-center">
                <button id="addMatchBtn" class="bg-[#118AB2] hover:bg-[#0E7DA0] text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300">
                    Adicionar Partida
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, onSnapshot, addDoc, updateDoc, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        // Corrected initialization: use __initial_auth_token directly
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null; 

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let userId = null;
        let isAuthReady = false;
        let currentEditingPlayerId = null;

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
            } else {
                if (initialAuthToken) {
                    try {
                        await signInWithCustomToken(auth, initialAuthToken);
                        userId = auth.currentUser.uid;
                    } catch (error) {
                        console.error("Erro ao autenticar com token personalizado:", error);
                        await signInAnonymously(auth);
                        userId = auth.currentUser.uid;
                    }
                } else {
                    await signInAnonymously(auth);
                    userId = auth.currentUser.uid;
                }
            }
            isAuthReady = true;
            console.log("Firebase Auth Ready. User ID:", userId);
            initializeFirestoreListener();
        });

        let playerData = [];
        let playerOverviewChartInstance;

        function wrapLabel(str, maxWidth) {
            if (str.length <= maxWidth) {
                return str;
            }
            const words = str.split(' ');
            const lines = [];
            let currentLine = words[0];
            for (let i = 1; i < words.length; i++) {
                if (currentLine.length + words[i].length + 1 <= maxWidth) {
                    currentLine += ' ' + words[i];
                } else {
                    lines.push(currentLine);
                    currentLine = words[i];
                }
            }
            lines.push(currentLine);
            return lines;
        }

        const tooltipTitleCallback = function(tooltipItems) {
            const item = tooltipItems[0];
            let label = item.chart.data.labels[item.dataIndex];
            if (Array.isArray(label)) {
              return label.join(' ');
            } else {
              return label;
            }
        };
        
        const commonChartOptions = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    labels: {
                        color: '#CBD5E0',
                        font: { size: 12 }
                    }
                },
                tooltip: {
                    callbacks: {
                        title: tooltipTitleCallback
                    },
                    backgroundColor: '#4A5568',
                    titleColor: '#E2E8F0',
                    bodyColor: '#E2E8F0',
                    borderColor: '#FF6B6B',
                    borderWidth: 1
                }
            },
            scales: {
                y: {
                    ticks: { color: '#CBD5E0', font: { size: 12 } },
                    grid: { color: '#4A5568' }
                },
                x: {
                    ticks: { color: '#CBD5E0', font: { size: 12 } },
                    grid: { color: '#4A5568' }
                }
            }
        };

        function calculateAverageStats(matches) {
            if (!matches || matches.length === 0) {
                return { kills: 0, deaths: 0, assists: 0, csPerMin: 0, visionScore: 0 };
            }
            const totalMatches = matches.length;
            const avg = matches.reduce((acc, match) => {
                acc.kills += match.kills;
                acc.deaths += match.deaths;
                acc.assists += match.assists;
                acc.csPerMin += match.csPerMin;
                acc.visionScore += match.visionScore;
                return acc;
            }, { kills: 0, deaths: 0, assists: 0, csPerMin: 0, visionScore: 0 });

            return {
                kills: (avg.kills / totalMatches).toFixed(1),
                deaths: (avg.deaths / totalMatches).toFixed(1),
                assists: (avg.assists / totalMatches).toFixed(1),
                csPerMin: (avg.csPerMin / totalMatches).toFixed(1),
                visionScore: (avg.visionScore / totalMatches).toFixed(1)
            };
        }

        function populateTable() {
            const tableBody = document.getElementById('playerStatsTableBody');
            tableBody.innerHTML = '';

            playerData.forEach((player) => {
                const avgStats = calculateAverageStats(player.matches);
                const row = tableBody.insertRow();
                row.className = 'border-b border-gray-700 hover:bg-gray-800';
                row.setAttribute('data-doc-id', player.id);

                const nameCell = row.insertCell();
                const killsCell = row.insertCell();
                const deathsCell = row.insertCell();
                const assistsCell = row.insertCell();
                const csPerMinCell = row.insertCell();
                const visionScoreCell = row.insertCell();
                const actionsCell = row.insertCell();

                nameCell.innerHTML = `<input type="text" class="player-input" data-stat="name" value="${player.name}">`;
                killsCell.textContent = avgStats.kills;
                deathsCell.textContent = avgStats.deaths;
                assistsCell.textContent = avgStats.assists;
                csPerMinCell.textContent = avgStats.csPerMin;
                visionScoreCell.textContent = avgStats.visionScore;
                actionsCell.innerHTML = `
                    <button class="manage-matches-btn bg-[#FFD166] hover:bg-[#E0B842] text-[#073B4C] font-bold py-1 px-2 rounded-lg text-sm mr-2">Gerenciar Partidas</button>
                    <button class="remove-player-btn bg-red-600 hover:bg-red-800 text-white font-bold py-1 px-2 rounded-lg text-sm">Remover</button>
                `;
            });

            document.querySelectorAll('.player-input').forEach(input => {
                input.addEventListener('change', updatePlayerNameInFirestore); 
            });
            document.querySelectorAll('.remove-player-btn').forEach(button => {
                button.addEventListener('click', removePlayerFromFirestore);
            });
            document.querySelectorAll('.manage-matches-btn').forEach(button => {
                button.addEventListener('click', openMatchManagementModal);
            });
        }

        async function updatePlayerNameInFirestore(event) {
            const input = event.target;
            const docId = input.closest('tr').getAttribute('data-doc-id');
            const newName = input.value;

            try {
                if (isAuthReady && userId) {
                    const playerDocRef = doc(db, `artifacts/${appId}/users/${userId}/lolPlayers`, docId);
                    await updateDoc(playerDocRef, { name: newName });
                } else {
                    console.warn("Firestore n√£o est√° pronto ou userId n√£o est√° dispon√≠vel para atualizar.");
                }
            } catch (e) {
                console.error("Erro ao atualizar o nome do jogador:", e);
            }
        }

        async function addPlayerToFirestore() {
            try {
                if (isAuthReady && userId) {
                    await addDoc(collection(db, `artifacts/${appId}/users/${userId}/lolPlayers`), {
                        name: 'Novo Jogador',
                        matches: [{ lane: 'Mid', kills: 0, deaths: 0, assists: 0, csPerMin: 0, visionScore: 0 }]
                    });
                } else {
                    console.warn("Firestore n√£o est√° pronto ou userId n√£o est√° dispon√≠vel para adicionar.");
                }
            } catch (e) {
                console.error("Erro ao adicionar novo documento:", e);
            }
        }

        async function removePlayerFromFirestore(event) {
            const docId = event.target.closest('tr').getAttribute('data-doc-id');
            try {
                if (isAuthReady && userId) {
                    await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/lolPlayers`, docId));
                } else {
                    console.warn("Firestore n√£o est√° pronto ou userId n√£o est√° dispon√≠vel para remover.");
                }
            } catch (e) {
                console.error("Erro ao remover o documento:", e);
            }
        }

        function calculatePerformanceScore(player) {
            const avgStats = calculateAverageStats(player.matches);
            const primaryLane = player.matches && player.matches.length > 0 ? player.matches[0].lane : 'Mid';

            let killsWeight = 1;
            let deathsWeight = 1;
            let assistsWeight = 1;
            let csPerMinWeight = 0.5;
            let visionScoreWeight = 0.1;

            if (primaryLane === 'Sup' || primaryLane === 'Jungle') {
                assistsWeight = 1.5;
                visionScoreWeight = 0.2;
                killsWeight = 0.8;
                csPerMinWeight = 0.3;
                deathsWeight = 1.2;
            } else {
                killsWeight = 1.2;
                csPerMinWeight = 0.7;
                assistsWeight = 0.8;
                visionScoreWeight = 0.05;
                deathsWeight = 1;
            }

            const kdaScore = (parseFloat(avgStats.kills) * killsWeight + parseFloat(avgStats.assists) * assistsWeight) / 
                             (parseFloat(avgStats.deaths) * deathsWeight > 0 ? parseFloat(avgStats.deaths) * deathsWeight : 1);
            
            return kdaScore + (parseFloat(avgStats.csPerMin) * csPerMinWeight) + (parseFloat(avgStats.visionScore) * visionScoreWeight);
        }

        function destroyCharts() {
            if (playerOverviewChartInstance) playerOverviewChartInstance.destroy();
        }

        function createCharts() {
            destroyCharts();

            const playerNames = playerData.map(p => p.name);
            const avgKillsData = playerData.map(p => parseFloat(calculateAverageStats(p.matches).kills));
            const avgDeathsData = playerData.map(p => parseFloat(calculateAverageStats(p.matches).deaths));
            const avgAssistsData = playerData.map(p => parseFloat(calculateAverageStats(p.matches).assists));
            const avgCsPerMinData = playerData.map(p => parseFloat(calculateAverageStats(p.matches).csPerMin));
            const avgVisionScoreData = playerData.map(p => parseFloat(calculateAverageStats(p.matches).visionScore));

            const playerOverviewCtx = document.getElementById('playerOverviewChart');
            if (playerOverviewCtx) {
                playerOverviewChartInstance = new Chart(playerOverviewCtx.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: playerNames,
                        datasets: [
                            {
                                label: 'Abates (K)',
                                data: avgKillsData,
                                backgroundColor: '#FF6B6B',
                                borderColor: '#073B4C',
                                borderWidth: 1
                            },
                            {
                                label: 'Mortes (D)',
                                data: avgDeathsData,
                                backgroundColor: '#118AB2',
                                borderColor: '#073B4C',
                                borderWidth: 1
                            },
                            {
                                label: 'Assist√™ncias (A)',
                                data: avgAssistsData,
                                backgroundColor: '#FFD166',
                                borderColor: '#073B4C',
                                borderWidth: 1
                            },
                            {
                                label: 'CS/min',
                                data: avgCsPerMinData,
                                backgroundColor: '#06D6A0',
                                borderColor: '#073B4C',
                                borderWidth: 1
                            },
                            {
                                label: 'Placar de Vis√£o',
                                data: avgVisionScoreData,
                                backgroundColor: '#577590',
                                borderColor: '#073B4C',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        ...commonChartOptions,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { color: '#CBD5E0', font: { size: 12 } },
                                grid: { color: '#4A5568' }
                            },
                            x: {
                                ticks: { color: '#CBD5E0', font: { size: 12 } },
                                grid: { display: false }
                            }
                        }
                    }
                });
            }

            // L√≥gica para a Tier List
            const rankedPlayers = [...playerData].map(player => ({
                ...player,
                score: calculatePerformanceScore(player)
            })).sort((a, b) => b.score - a.score);

            const tiers = { S: [], A: [], B: [], C: [], D: [] };
            const tierThresholds = {
                S: 15, // Limiar do Tier S ajustado para 15
                A: 10,
                B: 7,
                C: 3
            };

            let sTierCount = 0;
            for (const player of rankedPlayers) {
                if (sTierCount < 3 && player.score >= tierThresholds.S) {
                    tiers.S.push(player);
                    sTierCount++;
                } else if (player.score >= tierThresholds.A) {
                    tiers.A.push(player);
                } else if (player.score >= tierThresholds.B) {
                    tiers.B.push(player);
                } else if (player.score >= tierThresholds.C) {
                    tiers.C.push(player);
                } else {
                    tiers.D.push(player);
                }
            }

            const tierListDisplay = document.getElementById('tierListDisplay');
            tierListDisplay.innerHTML = ''; // Limpa o conte√∫do anterior

            const tierOrder = ['S', 'A', 'B', 'C', 'D'];
            tierOrder.forEach(tierKey => {
                const tierPlayers = tiers[tierKey];
                const tierCard = document.createElement('div');
                tierCard.className = `tier-card tier-${tierKey.toLowerCase()}`;
                tierCard.innerHTML = `<h4>Tier ${tierKey}</h4>`;
                if (tierPlayers.length > 0) {
                    tierPlayers.forEach(player => {
                        const playerDiv = document.createElement('p');
                        playerDiv.className = 'tier-player-name';
                        playerDiv.textContent = `${player.name} (${player.score.toFixed(2)})`;
                        tierCard.appendChild(playerDiv);
                    });
                } else {
                    const noPlayers = document.createElement('p');
                    noPlayers.className = 'text-sm text-gray-500';
                    noPlayers.textContent = 'Nenhum jogador nesta Tier.';
                    tierCard.appendChild(noPlayers);
                }
                tierListDisplay.appendChild(tierCard);
            });
        }

        function openMatchManagementModal(event) {
            const docId = event.target.closest('tr').getAttribute('data-doc-id');
            currentEditingPlayerId = docId;
            const player = playerData.find(p => p.id === docId);

            if (player) {
                document.getElementById('modalPlayerName').textContent = player.name;
                populateMatchesTableInModal(player.matches || []);
                document.getElementById('matchManagementModal').classList.remove('hidden');
            }
        }

        function closeMatchManagementModal() {
            document.getElementById('matchManagementModal').classList.add('hidden');
            currentEditingPlayerId = null;
        }

        function populateMatchesTableInModal(matches) {
            const tableBody = document.getElementById('modalMatchesTableBody');
            tableBody.innerHTML = '';

            if (matches.length === 0) {
                const row = tableBody.insertRow();
                const cell = row.insertCell();
                cell.colSpan = 8;
                cell.textContent = 'Nenhuma partida registrada para este jogador.';
                cell.className = 'text-center py-4 text-gray-500';
                return;
            }

            const lanes = ['Mid', 'Top', 'Jungle', 'Adc', 'Sup'];

            matches.forEach((match, index) => {
                const row = tableBody.insertRow();
                row.className = 'border-b border-gray-700 hover:bg-gray-800';
                row.setAttribute('data-match-index', index);

                row.insertCell().textContent = index + 1;
                
                const laneCell = row.insertCell();
                let laneSelectHtml = `<select class="match-select" data-stat="lane">`;
                lanes.forEach(lane => {
                    laneSelectHtml += `<option value="${lane}" ${match.lane === lane ? 'selected' : ''}>${lane}</option>`;
                });
                laneSelectHtml += `</select>`;
                laneCell.innerHTML = laneSelectHtml;

                row.insertCell().innerHTML = `<input type="number" step="0.1" class="match-input" data-stat="kills" value="${match.kills}">`;
                row.insertCell().innerHTML = `<input type="number" step="0.1" class="match-input" data-stat="deaths" value="${match.deaths}">`;
                row.insertCell().innerHTML = `<input type="number" step="0.1" class="match-input" data-stat="assists" value="${match.assists}">`;
                row.insertCell().innerHTML = `<input type="number" step="0.1" class="match-input" data-stat="csPerMin" value="${match.csPerMin}">`;
                row.insertCell().innerHTML = `<input type="number" step="1" class="match-input" data-stat="visionScore" value="${match.visionScore}">`;
                row.insertCell().innerHTML = `<button class="remove-match-btn bg-red-600 hover:bg-red-800 text-white font-bold py-1 px-2 rounded-lg text-sm">Remover</button>`;
            });

            document.querySelectorAll('#modalMatchesTableBody .match-input, #modalMatchesTableBody .match-select').forEach(input => {
                input.addEventListener('change', updateMatchInFirestore);
            });
            document.querySelectorAll('#modalMatchesTableBody .remove-match-btn').forEach(button => {
                button.addEventListener('click', removeMatchFromFirestore);
            });
        }

        async function updateMatchInFirestore(event) {
            const input = event.target;
            const matchIndex = parseInt(input.closest('tr').getAttribute('data-match-index'));
            const stat = input.getAttribute('data-stat');
            let value = input.value;

            if (stat !== 'lane') {
                value = parseFloat(value);
            }

            try {
                if (isAuthReady && userId && currentEditingPlayerId) {
                    const playerDocRef = doc(db, `artifacts/${appId}/users/${userId}/lolPlayers`, currentEditingPlayerId);
                    const player = playerData.find(p => p.id === currentEditingPlayerId);
                    
                    if (player && player.matches && player.matches[matchIndex]) {
                        const updatedMatches = [...player.matches];
                        updatedMatches[matchIndex][stat] = value;
                        await updateDoc(playerDocRef, { matches: updatedMatches });
                    }
                } else {
                    console.warn("Firestore n√£o est√° pronto ou userId/currentEditingPlayerId n√£o est√° dispon√≠vel para atualizar a partida.");
                }
            } catch (e) {
                console.error("Erro ao atualizar a partida:", e);
            }
        }

        async function addMatchToPlayerInFirestore() {
            try {
                if (isAuthReady && userId && currentEditingPlayerId) {
                    const playerDocRef = doc(db, `artifacts/${appId}/users/${userId}/lolPlayers`, currentEditingPlayerId);
                    const player = playerData.find(p => p.id === currentEditingPlayerId);

                    if (player) {
                        const updatedMatches = player.matches ? [...player.matches] : [];
                        updatedMatches.push({ lane: 'Mid', kills: 0, deaths: 0, assists: 0, csPerMin: 0, visionScore: 0 });
                        await updateDoc(playerDocRef, { matches: updatedMatches });
                    }
                } else {
                    console.warn("Firestore n√£o est√° pronto ou userId/currentEditingPlayerId n√£o est√° dispon√≠vel para adicionar partida.");
                }
            } catch (e) {
                console.error("Erro ao adicionar nova partida:", e);
            }
        }

        async function removeMatchFromFirestore(event) {
            const matchIndex = parseInt(event.target.closest('tr').getAttribute('data-match-index'));
            try {
                if (isAuthReady && userId && currentEditingPlayerId) {
                    const playerDocRef = doc(db, `artifacts/${appId}/users/${userId}/lolPlayers`, currentEditingPlayerId);
                    const player = playerData.find(p => p.id === currentEditingPlayerId);

                    if (player && player.matches) {
                        const updatedMatches = player.matches.filter((_, i) => i !== matchIndex);
                        await updateDoc(playerDocRef, { matches: updatedMatches });
                    }
                } else {
                    console.warn("Firestore n√£o est√° pronto ou userId/currentEditingPlayerId n√£o est√° dispon√≠vel para remover partida.");
                }
            } catch (e) {
                console.error("Erro ao remover partida:", e);
            }
        }

        function initializeFirestoreListener() {
            if (isAuthReady && userId) {
                const q = query(collection(db, `artifacts/${appId}/users/${userId}/lolPlayers`));
                onSnapshot(q, (snapshot) => {
                    playerData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    populateTable();
                    createCharts();
                    if (!document.getElementById('matchManagementModal').classList.contains('hidden') && currentEditingPlayerId) {
                        const player = playerData.find(p => p.id === currentEditingPlayerId);
                        if (player) {
                            populateMatchesTableInModal(player.matches || []);
                        }
                    }
                }, (error) => {
                    console.error("Erro ao ouvir dados do Firestore:", error);
                });
            } else {
                console.warn("N√£o foi poss√≠vel inicializar o listener do Firestore: Auth n√£o est√° pronto ou userId n√£o est√° dispon√≠vel.");
            }
        }

        document.getElementById('addPlayerBtn').addEventListener('click', addPlayerToFirestore);
        document.querySelector('.close-button').addEventListener('click', closeMatchManagementModal);
        document.getElementById('addMatchBtn').addEventListener('click', addMatchToPlayerInFirestore);

        window.onload = function() {
            document.getElementById('currentYear').textContent = new Date().getFullYear();
        };
    </script>
</body>
</html>
